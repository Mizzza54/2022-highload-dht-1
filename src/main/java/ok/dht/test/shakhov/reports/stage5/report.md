Как и в прошлых этапах, все результаты получены при 3 запущенных в разных процессах нодах на одном компьютере.

# Нагрузчное тестирование

Я стрелял только в одну ноду, она посылала запросы остальным. В анализе я испытывал параметры ack = 2, from = 3 (такие будут если их не указывать в запросе), так как это
сбалансированное соотношение между отказоустойчивостью и производительностью. В этом этапе я впервые столкнулся с тем, что нам рассказывали на 
лекциях про реальные продакшен сервисы, а именно, что нельзя резко подавать нагрузку на сервис, который долго не получал нагрузки. Сервису нужно время
для JIT-оптимизаций, наполнения кэшей, старта тредов в тредпулах и т.д.

## PUT
```
math.randomseed(os.time())

function request()
  path = "/v0/entity?id=" .. tostring(math.random(1, 10000000))
  body = tostring(math.random(1, 10000000))
  return wrk.format("PUT", path, wrk.headers, body)
end
```
Методом дихотомии была найдена точка разладки на 11000 RPS, сервис не смог справиться с заданным RPS.
Графики латенси достаточно похож по форме с графиком точки разладки для PUT из предыдущего этапа, текущий график чуть медленее растет в начале.

```
wrk -d 120 -t 4 -c 64 -R 11000 -L -s ../put.lua http://localhost:19234
Running 2m test @ http://localhost:19234
  4 threads and 64 connections
  Thread calibration: mean lat.: 30.342ms, rate sampling interval: 204ms
  Thread calibration: mean lat.: 38.355ms, rate sampling interval: 258ms
  Thread calibration: mean lat.: 32.509ms, rate sampling interval: 213ms
  Thread calibration: mean lat.: 30.980ms, rate sampling interval: 214ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     4.68s     3.04s   10.15s    54.63%
    Req/Sec     2.51k   200.33     3.06k    73.53%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    4.34s
 75.000%    7.59s
 90.000%    8.91s
 99.000%    9.82s
 99.900%   10.03s
 99.990%   10.12s
 99.999%   10.14s
100.000%   10.16s

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.577     0.000000            1         1.00
     609.791     0.100000       110034         1.11
    1517.567     0.200000       220130         1.25
    2531.327     0.300000       330271         1.43
    3428.351     0.400000       440101         1.67
    4337.663     0.500000       550332         2.00
    4804.607     0.550000       605288         2.22
    5631.999     0.600000       660193         2.50
    6328.319     0.650000       715360         2.86
    6860.799     0.700000       770460         3.33
    7589.887     0.750000       825222         4.00
    7913.471     0.775000       852931         4.44
    8130.559     0.800000       880552         5.00
    8302.591     0.825000       907948         5.71
    8470.527     0.850000       935401         6.67
    8675.327     0.875000       963573         8.00
    8790.015     0.887500       976962         8.89
    8912.895     0.900000       990707        10.00
    9035.775     0.912500      1004446        11.43
    9158.655     0.925000      1018378        13.33
    9273.343     0.937500      1031500        16.00
    9338.879     0.943750      1038861        17.78
    9396.223     0.950000      1045252        20.00
    9469.951     0.956250      1052760        22.86
    9535.487     0.962500      1059942        26.67
    9592.831     0.968750      1066244        32.00
    9625.599     0.971875      1069678        35.56
    9658.367     0.975000      1073221        40.00
    9682.943     0.978125      1076192        45.71
    9715.711     0.981250      1079582        53.33
    9756.671     0.984375      1083485        64.00
    9773.055     0.985938      1084887        71.11
    9797.631     0.987500      1086950        80.00
    9814.015     0.989062      1088545        91.43
    9830.399     0.990625      1090118       106.67
    9854.975     0.992188      1091899       128.00
    9871.359     0.992969      1092860       142.22
    9887.743     0.993750      1093701       160.00
    9904.127     0.994531      1094561       182.86
    9920.511     0.995313      1095299       213.33
    9936.895     0.996094      1096148       256.00
    9945.087     0.996484      1096539       284.44
    9953.279     0.996875      1096834       320.00
    9969.663     0.997266      1097520       365.71
    9977.855     0.997656      1097857       426.67
    9986.047     0.998047      1098146       512.00
    9994.239     0.998242      1098468       568.89
   10002.431     0.998437      1098719       640.00
   10002.431     0.998633      1098719       731.43
   10018.815     0.998828      1099039       853.33
   10027.007     0.999023      1099156      1024.00
   10035.199     0.999121      1099271      1137.78
   10043.391     0.999219      1099416      1280.00
   10051.583     0.999316      1099536      1462.86
   10059.775     0.999414      1099632      1706.67
   10067.967     0.999512      1099732      2048.00
   10067.967     0.999561      1099732      2275.56
   10076.159     0.999609      1099846      2560.00
   10076.159     0.999658      1099846      2925.71
   10084.351     0.999707      1099920      3413.33
   10092.543     0.999756      1099976      4096.00
   10092.543     0.999780      1099976      4551.11
   10100.735     0.999805      1100041      5120.00
   10100.735     0.999829      1100041      5851.43
   10108.927     0.999854      1100090      6826.67
   10108.927     0.999878      1100090      8192.00
   10108.927     0.999890      1100090      9102.22
   10117.119     0.999902      1100147     10240.00
   10117.119     0.999915      1100147     11702.86
   10117.119     0.999927      1100147     13653.33
   10117.119     0.999939      1100147     16384.00
   10125.311     0.999945      1100179     18204.44
   10125.311     0.999951      1100179     20480.00
   10125.311     0.999957      1100179     23405.71
   10125.311     0.999963      1100179     27306.67
   10125.311     0.999969      1100179     32768.00
   10125.311     0.999973      1100179     36408.89
   10133.503     0.999976      1100190     40960.00
   10133.503     0.999979      1100190     46811.43
   10133.503     0.999982      1100190     54613.33
   10141.695     0.999985      1100202     65536.00
   10141.695     0.999986      1100202     72817.78
   10141.695     0.999988      1100202     81920.00
   10141.695     0.999989      1100202     93622.86
   10141.695     0.999991      1100202    109226.67
   10141.695     0.999992      1100202    131072.00
   10141.695     0.999993      1100202    145635.56
   10141.695     0.999994      1100202    163840.00
   10149.887     0.999995      1100203    187245.71
   10149.887     0.999995      1100203    218453.33
   10158.079     0.999996      1100208    262144.00
   10158.079     1.000000      1100208          inf
#[Mean    =     4675.324, StdDeviation   =     3040.863]
#[Max     =    10149.888, Total count    =      1100208]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1210690 requests in 2.00m, 68.12MB read
Requests/sec:  10089.18
Transfer/sec:    581.31KB
```


Отступив на 20% от точки разладки (на 8800 RPS) видим, что сервис начал справляться. 

```
wrk -d 120 -t 4 -c 64 -R 8800 -L -s ../put.lua http://localhost:19234
Running 2m test @ http://localhost:19234
  4 threads and 64 connections
  Thread calibration: mean lat.: 2.835ms, rate sampling interval: 11ms
  Thread calibration: mean lat.: 2.847ms, rate sampling interval: 11ms
  Thread calibration: mean lat.: 3.019ms, rate sampling interval: 11ms
  Thread calibration: mean lat.: 2.831ms, rate sampling interval: 11ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     4.94ms    4.39ms  47.39ms   86.25%
    Req/Sec     2.31k   580.25     6.40k    71.23%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    3.20ms
 75.000%    6.24ms
 90.000%   10.92ms
 99.000%   20.93ms
 99.900%   31.71ms
 99.990%   38.88ms
 99.999%   43.42ms
100.000%   47.42ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.394     0.000000            1         1.00
       1.553     0.100000        96981         1.11
       1.926     0.200000       193754         1.25
       2.279     0.300000       290733         1.43
       2.677     0.400000       387378         1.67
       3.199     0.500000       483826         2.00
       3.551     0.550000       532194         2.22
       4.005     0.600000       580611         2.50
       4.583     0.650000       628902         2.86
       5.323     0.700000       677273         3.33
       6.239     0.750000       725584         4.00
       6.787     0.775000       749844         4.44
       7.403     0.800000       773992         5.00
       8.095     0.825000       798233         5.71
       8.895     0.850000       822538         6.67
       9.815     0.875000       846530         8.00
      10.335     0.887500       858608         8.89
      10.919     0.900000       870788        10.00
      11.567     0.912500       882796        11.43
      12.319     0.925000       894871        13.33
      13.183     0.937500       907027        16.00
      13.663     0.943750       913035        17.78
      14.215     0.950000       919093        20.00
      14.823     0.956250       925153        22.86
      15.495     0.962500       931165        26.67
      16.255     0.968750       937211        32.00
      16.719     0.971875       940307        35.56
      17.199     0.975000       943332        40.00
      17.743     0.978125       946302        45.71
      18.367     0.981250       949340        53.33
      19.119     0.984375       952363        64.00
      19.519     0.985938       953857        71.11
      20.015     0.987500       955377        80.00
      20.543     0.989062       956864        91.43
      21.183     0.990625       958359       106.67
      21.951     0.992188       959876       128.00
      22.367     0.992969       960629       142.22
      22.863     0.993750       961389       160.00
      23.487     0.994531       962142       182.86
      24.191     0.995313       962890       213.33
      25.087     0.996094       963660       256.00
      25.599     0.996484       964027       284.44
      26.223     0.996875       964410       320.00
      26.911     0.997266       964784       365.71
      27.647     0.997656       965161       426.67
      28.511     0.998047       965538       512.00
      29.039     0.998242       965725       568.89
      29.615     0.998437       965915       640.00
      30.287     0.998633       966105       731.43
      30.975     0.998828       966294       853.33
      31.791     0.999023       966481      1024.00
      32.223     0.999121       966574      1137.78
      32.671     0.999219       966671      1280.00
      33.151     0.999316       966768      1462.86
      33.663     0.999414       966860      1706.67
      34.399     0.999512       966955      2048.00
      34.783     0.999561       966999      2275.56
      35.231     0.999609       967048      2560.00
      35.615     0.999658       967098      2925.71
      36.095     0.999707       967142      3413.33
      36.607     0.999756       967187      4096.00
      37.023     0.999780       967212      4551.11
      37.407     0.999805       967236      5120.00
      37.791     0.999829       967261      5851.43
      38.239     0.999854       967283      6826.67
      38.559     0.999878       967305      8192.00
      38.719     0.999890       967317      9102.22
      38.943     0.999902       967329     10240.00
      39.359     0.999915       967341     11702.86
      39.711     0.999927       967353     13653.33
      40.127     0.999939       967364     16384.00
      40.319     0.999945       967373     18204.44
      40.639     0.999951       967376     20480.00
      40.927     0.999957       967382     23405.71
      41.471     0.999963       967388     27306.67
      41.759     0.999969       967394     32768.00
      41.919     0.999973       967397     36408.89
      42.015     0.999976       967400     40960.00
      42.431     0.999979       967404     46811.43
      42.655     0.999982       967406     54613.33
      43.167     0.999985       967409     65536.00
      43.231     0.999986       967410     72817.78
      43.359     0.999988       967412     81920.00
      43.423     0.999989       967413     93622.86
      43.711     0.999991       967415    109226.67
      43.839     0.999992       967416    131072.00
      44.095     0.999993       967417    145635.56
      44.415     0.999994       967419    163840.00
      44.415     0.999995       967419    187245.71
      44.415     0.999995       967419    218453.33
      44.959     0.999996       967420    262144.00
      44.959     0.999997       967420    291271.11
      45.215     0.999997       967421    327680.00
      45.215     0.999997       967421    374491.43
      45.215     0.999998       967421    436906.67
      46.047     0.999998       967422    524288.00
      46.047     0.999998       967422    582542.22
      46.047     0.999998       967422    655360.00
      46.047     0.999999       967422    748982.86
      46.047     0.999999       967422    873813.33
      47.423     0.999999       967423   1048576.00
      47.423     1.000000       967423          inf
#[Mean    =        4.938, StdDeviation   =        4.387]
#[Max     =       47.392, Total count    =       967423]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1055684 requests in 2.00m, 59.40MB read
Requests/sec:   8797.30
Transfer/sec:    506.88KB
```

График latency растет сильно медленее, чем у точки разладки, как и в предыдущих этапах максимум latency сильно отличается от среднего,
присутствуют скачек в latency у крайне правых перцентилей, но в отличии от предыдушего этапа скачки в латенси тут гораздо менее ярко выражены.
Судя по логам GC, которые собирались во время нагрузочного тестирования я увидел, что GC активно работал, используя разные режимы:

```
[1271.714s][info][gc] GC(7078) Pause Young (Concurrent Start) (G1 Evacuation Pause) 110M->55M(128M) 4.979ms
[1271.714s][info][gc] GC(7079) Concurrent Mark Cycle
[1271.758s][info][gc] GC(7079) Pause Remark 62M->62M(128M) 2.822ms
[1271.793s][info][gc] GC(7079) Pause Cleanup 68M->68M(128M) 0.287ms
[1271.794s][info][gc] GC(7079) Concurrent Mark Cycle 80.017ms
[1272.014s][info][gc] GC(7080) Pause Young (Prepare Mixed) (G1 Evacuation Pause) 109M->55M(128M) 4.642ms
[1272.041s][info][gc] GC(7081) Pause Young (Mixed) (G1 Evacuation Pause) 59M->55M(128M) 4.669ms
[1272.317s][info][gc] GC(7082) Pause Young (Normal) (G1 Evacuation Pause) 110M->55M(128M) 4.177ms
[1272.605s][info][gc] GC(7083) Pause Young (Normal) (G1 Evacuation Pause) 110M->55M(128M) 3.632ms
```

Можно заметить, что среднее и максимальное значение latency больше, чем в предыдущем этапе в 1.5-2.0 раза, я связываю это с GC, т.к.
продолжительность пауз GC тоже увеличилась в 1.5-2.0 раза.
Также при нагрузочном тестировании я столкнулся с OOM при большом количестве RPS, сняв Heap Dump и проанализиров, я предположил, что проблема связана
с большим количеством аллокаций соединений и с сильно разрастающейся memtable. Я снизил размер memtable с 4 MB до 1 MB, добавил небольшой спинлок, чтобы флаш
работал чуть быстрее, и ограничил максимальное количество соединений в пуле соединений HttpClient с помощью ключика для JVM -Djdk.httpclient.connectionPoolSize=500,
это помогло, больше OOM я не видел.

По сравнению с предыдущим этапом PUT сделал в 3.6 раз больше RPS.


## GET
Скрипт:
```
math.randomseed(os.time())

function request()
  path = "/v0/entity?id=" .. tostring(math.random(1, 10000000))
  return wrk.format("GET", path, wrk.headers, wrk.body)
end
```
Методом дихотомии была найдена точка разладки на 5000 RPS, сервис не смог справиться с заданным RPS.  Non-2xx or 3xx responses - это ненайденные
ключи, на нодах не было ошибок, я проверил в логах.

```
wrk -d 120 -t 4 -c 64 -R 5000 -L -s ../get.lua http://localhost:19234
Running 2m test @ http://localhost:19234
  4 threads and 64 connections
  Thread calibration: mean lat.: 329.043ms, rate sampling interval: 1398ms
  Thread calibration: mean lat.: 313.437ms, rate sampling interval: 1345ms
  Thread calibration: mean lat.: 337.743ms, rate sampling interval: 1482ms
  Thread calibration: mean lat.: 312.189ms, rate sampling interval: 1338ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     5.21s     2.86s   11.00s    58.77%
    Req/Sec     1.14k    48.85     1.26k    72.38%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    5.16s
 75.000%    7.45s
 90.000%    9.33s
 99.000%   10.49s
 99.900%   10.77s
 99.990%   10.93s
 99.999%   11.00s
100.000%   11.01s

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

     604.159     0.000000            1         1.00
    1110.015     0.100000        50155         1.11
    2299.903     0.200000       100161         1.25
    3323.903     0.300000       150305         1.43
    4251.647     0.400000       200410         1.67
    5156.863     0.500000       250527         2.00
    5574.655     0.550000       275535         2.22
    5963.775     0.600000       300449         2.50
    6385.663     0.650000       325511         2.86
    6836.223     0.700000       350686         3.33
    7450.623     0.750000       375618         4.00
    7827.455     0.775000       388190         4.44
    8179.711     0.800000       400638         5.00
    8503.295     0.825000       413130         5.71
    8790.015     0.850000       425647         6.67
    9060.351     0.875000       438411         8.00
    9199.615     0.887500       444565         8.89
    9330.687     0.900000       450699        10.00
    9486.335     0.912500       457006        11.43
    9650.175     0.925000       463348        13.33
    9805.823     0.937500       469682        16.00
    9879.551     0.943750       472560        17.78
    9953.279     0.950000       475891        20.00
   10018.815     0.956250       478902        22.86
   10092.543     0.962500       482051        26.67
   10166.271     0.968750       485209        32.00
   10207.231     0.971875       486965        35.56
   10239.999     0.975000       488300        40.00
   10280.959     0.978125       489811        45.71
   10330.111     0.981250       491354        53.33
   10379.263     0.984375       493038        64.00
   10403.839     0.985938       493784        71.11
   10436.607     0.987500       494641        80.00
   10469.375     0.989062       495466        91.43
   10493.951     0.990625       496102       106.67
   10526.719     0.992188       496880       128.00
   10543.103     0.992969       497285       142.22
   10559.487     0.993750       497650       160.00
   10584.063     0.994531       498111       182.86
   10600.447     0.995313       498388       213.33
   10633.215     0.996094       498818       256.00
   10649.599     0.996484       499058       284.44
   10657.791     0.996875       499170       320.00
   10674.175     0.997266       499406       365.71
   10698.751     0.997656       499634       426.67
   10715.135     0.998047       499798       512.00
   10723.327     0.998242       499854       568.89
   10739.711     0.998437       500002       640.00
   10747.903     0.998633       500091       731.43
   10756.095     0.998828       500163       853.33
   10772.479     0.999023       500241      1024.00
   10788.863     0.999121       500287      1137.78
   10805.247     0.999219       500356      1280.00
   10813.439     0.999316       500392      1462.86
   10821.631     0.999414       500449      1706.67
   10829.823     0.999512       500481      2048.00
   10838.015     0.999561       500509      2275.56
   10846.207     0.999609       500529      2560.00
   10854.399     0.999658       500550      2925.71
   10887.167     0.999707       500587      3413.33
   10895.359     0.999756       500599      4096.00
   10903.551     0.999780       500612      4551.11
   10911.743     0.999805       500636      5120.00
   10911.743     0.999829       500636      5851.43
   10919.935     0.999854       500663      6826.67
   10919.935     0.999878       500663      8192.00
   10928.127     0.999890       500686      9102.22
   10928.127     0.999902       500686     10240.00
   10928.127     0.999915       500686     11702.86
   10928.127     0.999927       500686     13653.33
   10952.703     0.999939       500691     16384.00
   10960.895     0.999945       500695     18204.44
   10977.279     0.999951       500699     20480.00
   10977.279     0.999957       500699     23405.71
   10985.471     0.999963       500709     27306.67
   10985.471     0.999969       500709     32768.00
   10985.471     0.999973       500709     36408.89
   10985.471     0.999976       500709     40960.00
   10993.663     0.999979       500714     46811.43
   10993.663     0.999982       500714     54613.33
   10993.663     0.999985       500714     65536.00
   10993.663     0.999986       500714     72817.78
   10993.663     0.999988       500714     81920.00
   11001.855     0.999989       500718     93622.86
   11001.855     0.999991       500718    109226.67
   11001.855     0.999992       500718    131072.00
   11001.855     0.999993       500718    145635.56
   11001.855     0.999994       500718    163840.00
   11001.855     0.999995       500718    187245.71
   11001.855     0.999995       500718    218453.33
   11010.047     0.999996       500720    262144.00
   11010.047     1.000000       500720          inf
#[Mean    =     5206.282, StdDeviation   =     2857.997]
#[Max     =    11001.856, Total count    =       500720]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  547270 requests in 2.00m, 32.66MB read
  Non-2xx or 3xx responses: 262749
Requests/sec:   4560.56
Transfer/sec:    278.72KB
```

Отступив на 20% от точки разладки (на 4000 RPS) видим, что сервис начал справляться.
Присутствуют скачки в latency на крайне правых перцентилях, максимум latency сильно больше, чем в предыдущем этапе,
Это связано с тем, что размер sstable был уменьшен, тем самым увеличивается их количество, а также более активной работой GC, в логах предыдущего этапа
были только Pause Young (Normal)

```
[1323.822s][info][gc] GC(5157) Pause Young (Concurrent Start) (G1 Evacuation Pause) 112M->45M(128M) 1.982ms
[1323.822s][info][gc] GC(5158) Concurrent Mark Cycle
[1323.852s][info][gc] GC(5158) Pause Remark 53M->53M(128M) 1.938ms
[1323.879s][info][gc] GC(5158) Pause Cleanup 67M->67M(128M) 0.152ms
[1323.879s][info][gc] GC(5158) Concurrent Mark Cycle 56.685ms
[1323.964s][info][gc] GC(5159) Pause Young (Prepare Mixed) (G1 Evacuation Pause) 111M->45M(128M) 2.188ms
[1323.974s][info][gc] GC(5160) Pause Young (Mixed) (G1 Evacuation Pause) 50M->45M(128M) 2.449ms
[1324.116s][info][gc] GC(5161) Pause Young (Normal) (G1 Evacuation Pause) 111M->45M(128M) 1.933ms
```

```
 wrk -d 120 -t 4 -c 64 -R 4000 -L -s ../get.lua http://localhost:19234
Running 2m test @ http://localhost:19234
  4 threads and 64 connections
  Thread calibration: mean lat.: 3.244ms, rate sampling interval: 11ms
  Thread calibration: mean lat.: 3.134ms, rate sampling interval: 11ms
  Thread calibration: mean lat.: 3.138ms, rate sampling interval: 11ms
  Thread calibration: mean lat.: 3.154ms, rate sampling interval: 11ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     3.74ms    3.21ms  51.04ms   89.86%
    Req/Sec     1.05k   253.90     3.10k    82.02%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    2.73ms
 75.000%    4.17ms
 90.000%    7.00ms
 99.000%   17.36ms
 99.900%   28.46ms
 99.990%   40.51ms
 99.999%   45.60ms
100.000%   51.07ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.415     0.000000            1         1.00
       1.501     0.100000        44015         1.11
       1.830     0.200000        88051         1.25
       2.115     0.300000       132079         1.43
       2.403     0.400000       175895         1.67
       2.731     0.500000       219994         2.00
       2.921     0.550000       241899         2.22
       3.143     0.600000       263934         2.50
       3.407     0.650000       285837         2.86
       3.737     0.700000       307789         3.33
       4.167     0.750000       329864         4.00
       4.431     0.775000       340810         4.44
       4.751     0.800000       351770         5.00
       5.135     0.825000       362742         5.71
       5.607     0.850000       373806         6.67
       6.207     0.875000       384750         8.00
       6.575     0.887500       390245         8.89
       7.003     0.900000       395723        10.00
       7.531     0.912500       401225        11.43
       8.163     0.925000       406703        13.33
       8.975     0.937500       412200        16.00
       9.447     0.943750       414982        17.78
       9.999     0.950000       417708        20.00
      10.623     0.956250       420449        22.86
      11.311     0.962500       423195        26.67
      12.159     0.968750       425950        32.00
      12.655     0.971875       427313        35.56
      13.215     0.975000       428698        40.00
      13.855     0.978125       430065        45.71
      14.567     0.981250       431435        53.33
      15.431     0.984375       432818        64.00
      15.903     0.985938       433501        71.11
      16.431     0.987500       434182        80.00
      16.991     0.989062       434882        91.43
      17.631     0.990625       435561       106.67
      18.399     0.992188       436258       128.00
      18.879     0.992969       436597       142.22
      19.311     0.993750       436937       160.00
      19.903     0.994531       437274       182.86
      20.575     0.995313       437620       213.33
      21.263     0.996094       437960       256.00
      21.727     0.996484       438132       284.44
      22.255     0.996875       438306       320.00
      22.815     0.997266       438476       365.71
      23.519     0.997656       438648       426.67
      24.559     0.998047       438820       512.00
      25.103     0.998242       438907       568.89
      25.759     0.998437       438994       640.00
      26.527     0.998633       439076       731.43
      27.535     0.998828       439162       853.33
      28.575     0.999023       439248      1024.00
      29.295     0.999121       439291      1137.78
      30.031     0.999219       439335      1280.00
      30.639     0.999316       439377      1462.86
      31.727     0.999414       439420      1706.67
      32.863     0.999512       439465      2048.00
      33.279     0.999561       439484      2275.56
      33.951     0.999609       439506      2560.00
      34.559     0.999658       439528      2925.71
      35.231     0.999707       439549      3413.33
      36.479     0.999756       439570      4096.00
      37.055     0.999780       439581      4551.11
      37.663     0.999805       439592      5120.00
      38.463     0.999829       439602      5851.43
      39.231     0.999854       439613      6826.67
      39.839     0.999878       439624      8192.00
      40.287     0.999890       439629      9102.22
      40.575     0.999902       439636     10240.00
      41.151     0.999915       439640     11702.86
      41.503     0.999927       439645     13653.33
      42.207     0.999939       439651     16384.00
      42.367     0.999945       439653     18204.44
      42.655     0.999951       439656     20480.00
      43.135     0.999957       439659     23405.71
      43.487     0.999963       439661     27306.67
      43.647     0.999969       439664     32768.00
      43.679     0.999973       439665     36408.89
      43.775     0.999976       439667     40960.00
      43.903     0.999979       439668     46811.43
      43.967     0.999982       439669     54613.33
      45.375     0.999985       439671     65536.00
      45.375     0.999986       439671     72817.78
      45.535     0.999988       439672     81920.00
      45.599     0.999989       439673     93622.86
      45.599     0.999991       439673    109226.67
      46.815     0.999992       439674    131072.00
      46.815     0.999993       439674    145635.56
      47.711     0.999994       439675    163840.00
      47.711     0.999995       439675    187245.71
      47.711     0.999995       439675    218453.33
      49.759     0.999996       439676    262144.00
      49.759     0.999997       439676    291271.11
      49.759     0.999997       439676    327680.00
      49.759     0.999997       439676    374491.43
      49.759     0.999998       439676    436906.67
      51.071     0.999998       439677    524288.00
      51.071     1.000000       439677          inf
#[Mean    =        3.736, StdDeviation   =        3.208]
#[Max     =       51.040, Total count    =       439677]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  479875 requests in 2.00m, 28.64MB read
  Non-2xx or 3xx responses: 230817
Requests/sec:   3998.95
Transfer/sec:    244.37KB
```

GET сделал в 1.6 раз больше RPS, чем на предыдущем этапе.

# Профилирование

## CPU

### PUT

1. ~60% сэмплов - асинхронное сетевое взаимодействие между нодами (10% из которых возвращение соединения в пул соединений)
2. ~7% сэмплов - работа селектора one-nio по чтению запроса и рассылке внутренних запросов
3. ~7% сэмплов - выполнение коллбеков - аггрегация ack ответов, трансформация ответов, логика по получению ack-быстрых ответов
4. ~6% сэмплов - забор задачи из очереди экзекутора
5. ~5 сэмплов - GC
6. ~3.3% сэмплов - response-воркер пишет ответ в сеть
7. ~2% сэмплов - вставка в memtable

По сравнению с предыдущем этапом получилось улучшить сетевое взаимодействие между нодами, но сильно вылез GC

Белые квадратики с предыдущего этапа под еще большей нагрузкой превратились в полосы.

### GET

1. ~40% сэмплов - воркер ищет данные по своим sstables
2. ~25% сэмплов - асинхронное сетевое взаимодействие между нодами (4% из которых возвращение соединения в пул соединений)
3. ~5% сэмплов - забор задачи из очереди экзекутора
4. ~2% сэмплов - response-воркер пишет ответ в сеть

По сравнению с предыдущем этапом сетевое взаимодействие перестало сильно доминировать в сэмплах, и на первый план вышла "полезная" работа
по поиску данных в sstables, это связано с тем, что мы добавили асинхронность и теперь воркеры не блокируются как раньше, а также мы увеличили количество
sstables для поиска.

И в GET, и в PUT большую часть сэмплов забора задачи из экзекутора - это notEmpty.await(), это значит что очередь недозаполняется, но сложно понять какая именно,
потому что у меня везде используется один и тот же класс очереди, я скопировал класс ArrayBlockingQueue к себе в проект и добавил туда логгирование
перед каждым 10_000-ысячным вызовом notEmpty.await(), затем я поднял ноды вместе с этой очередью и дал нагрузку, так как в логах пишется имя треда, а треды у экзекуторов у 
меня именованные, то я смог определить, что при PUT нагрузке очередь недозаполняется в основном на internal и response экзекуторах, а при GET
на экзекуторах http client и response, в связи с этим я уменьшил количество потоков на response экзекуторе

Белые квадратики с предыдущего этапа под еще большей нагрузкой превратились в полосы.

## ALLOC

### PUT

1. ~37% сэмплов - аллокации от HTTP Client
2. ~21% сэмплов - создание финального Response при аггрегации первых ack-ответов
3. ~15% сэмплов - конвертация ответа на внутренний запрос в ResponseWithTimestamp
4. ~13% сэмплов - аллокации создания внутренних запросов и навешивания на них коллбеков
5. ~10% сэмплов - аллокации вставки в memtable и создания Response для внутреннего запроса
6. ~5% сэмплов - аллокации one-nio при отправке запроса


### GET

1. ~39% сэмплов - аллокации от HTTP Client
2. ~20% сэмплов - аллокации во время поиска по sstable
3. ~8% сэмплов - конвертация ответа на внутренний запрос в ResponseWithTimestamp
4. ~5% сэмплов - аллокации создания внутренних запросов и навешивания на них коллбеков
5. ~4% сэмплов - аллокации one-nio при отправке запроса
6. ~4% сэмплов - создание финального Response при аггрегации первых ack-ответов


Как в GET, так и в PUT по сравнению с предыдущим этапом пропали аллокации селектора при приема запроса и вставки в очередь, на самом деле они все еще есть
просто количество других аллокаций сильно возросло из-за большого количества параллельных внутренних запросов (благодаря асинхронщине), их аггрегации, благодаря
увеличению количества sstables, и теперь аллокации селектора при приема запроса и вставки в очередь редко пересекают TLAB (при пересечении TLAB
сэмпл попадает в профайл)

На профилях видны вспышки, по паттерну они совпадают с паттерном работы GC на CPU профиле, я думаю, что это связано с тем, что GC тоже использует TLAB, как и async-profiler.
Cоздание финального Response при аггрегации первых ack-ответов можно не делать, если мы будем использовать лишь один вид HttpClient (чтобы не было
разных типов Response), отправим клиенту Response, который победит в аггрегации, удалив служебную инфу, также это избавит нас от конвертация ответа на внутренний запрос в ResponseWithTimestamp.
Но скорее всего от этого мы больше проиграем в CPU, т.к. one-nio очень быстрый как сервер, но по словам создателей, в нем не очень хороший
HttpClient, а в Java есть неплохой HttpClient с неблокирующим API. 

## LOCK

### PUT


1. ~25% сэмплов - лок на SelectorManager, когда происходит регистрация события, которого селектор ждет
2. ~23% сэмплов - лок на ConnectionPool
3. ~14% сэмплов - лок на SelectorManager, когда в цикле обрабатывает зарегистрированные события
4. ~11% сэмплов - лок на HttpClientImpl при работе с таймаутами
5. ~10% сэмплов - лок флажка прерывания в реализации Selector, когда происходит сброс флажка прерывания

### GET

1. ~25% сэмплов - лок на ConnectionPool
2. ~18% сэмплов - лок на SelectorManager, когда происходит регистрация события, которого селектор ждет
3. ~15% сэмплов - лок флажка прерывания в реализации Selector, когда происходит сброс флажка прерывания
4. ~12% сэмплов - лок на SelectorManager, когда в цикле обрабатывает зарегистрированные события
5. ~10% сэмплов - лок на HttpClientImpl при работе с таймаутами


По сравнению с предыдущим этапом появился серьезный lock contention на ConnectionPool, это связано с тем, что из-за асинхронной природы
создается очень много соединений (особенно в начале когда пул пустой, JIT не отработал и все работает как черепаха), потом они все
кладутся в пул, и это делает его очень жирным, а удаляются они оттуда по дефолту через 20 минут. Внутри пул реализован на sorted LinkedList, проход по которому не очень дешёвая операция
с точки зрения CPU из-за скачков по ссылкам (ухудшает кэширование), так к этому всему добавляется еще и то, что LinkedList
в пуле большой, в итоге лок держится слишком долго и происходит contention. На месте авторов HttpClient я бы попробовал TreeMap вместо LinkedList и попрофилировал, а для себя я ограничил размер
пула с помощью ключика для JVM -Djdk.httpclient.connectionPoolSize=500. Так как мы знаем хосты наших нод, неплохо было бы перед запуском сервера 
преаллоцировать какое-то количество соединений и держать их постоянно в пуле, а вот если уже этих не будет хватать, то создавать новые
и экспайрить их через время