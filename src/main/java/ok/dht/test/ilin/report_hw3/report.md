Тестирование при 3 шардах, все запускалось на Mac m1 в трех jvm. 
(Хотелось бы запускать на реальных физических машинах, но это стоит денег, а баллы за них давать пока что не очень хотят)

# PUT

Выдерживаемый рейт (90-ый персентиль меньше 5ms) сильно упал, при рейте 25000 даже 50-ый персентиль стал 9.18ms,
по-нагружав с разными рейтами получилось что сервер выдерживает рейт 16250 (90-ый персентиль меньше 5ms). 
Все нагружалось в 64 коннекшена и 4 потока.

`wrk2 -R 16250 -c 64 -t 4 -d 30 -s src/main/java/ok/dht/test/ilin/scripts/put.lua -L http://localhost:19234`

```
Running 30s test @ http://localhost:19234
  4 threads and 64 connections
  Thread calibration: mean lat.: 2.326ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.328ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.347ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.332ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     4.16ms    9.92ms 108.48ms   93.20%
    Req/Sec     4.28k   558.52     8.11k    82.77%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.56ms
 75.000%    2.25ms
 90.000%    6.56ms
 99.000%   51.81ms
 99.900%   93.18ms
 99.990%   99.26ms
 99.999%  107.84ms
100.000%  108.54ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.062     0.000000            1         1.00
       0.711     0.100000        32445         1.11
       0.951     0.200000        64839         1.25
       1.158     0.300000        97252         1.43
       1.358     0.400000       129608         1.67
       1.564     0.500000       161895         2.00
       1.673     0.550000       178077         2.22
       1.791     0.600000       194351         2.50
       1.918     0.650000       210448         2.86
       2.065     0.700000       226732         3.33
       2.245     0.750000       242868         4.00
       2.369     0.775000       250959         4.44
       2.531     0.800000       259032         5.00
       2.763     0.825000       267089         5.71
       3.151     0.850000       275186         6.67
       3.967     0.875000       283247         8.00
       5.103     0.887500       287295         8.89
       6.563     0.900000       291341        10.00
       8.607     0.912500       295395        11.43
      12.415     0.925000       299435        13.33
      15.103     0.937500       303490        16.00
      16.943     0.943750       305510        17.78
      22.719     0.950000       307531        20.00
      26.047     0.956250       309553        22.86
      28.559     0.962500       311581        26.67
      31.679     0.968750       313600        32.00
      33.471     0.971875       314617        35.56
      35.039     0.975000       315632        40.00
      36.607     0.978125       316632        45.71
      39.327     0.981250       317645        53.33
      44.447     0.984375       318653        64.00
      46.399     0.985938       319163        71.11
      48.479     0.987500       319665        80.00
      50.687     0.989062       320176        91.43
      52.639     0.990625       320681       106.67
      57.535     0.992188       321182       128.00
      61.791     0.992969       321437       142.22
      66.431     0.993750       321688       160.00
      72.447     0.994531       321942       182.86
      76.799     0.995313       322194       213.33
      79.871     0.996094       322448       256.00
      81.343     0.996484       322573       284.44
      82.879     0.996875       322701       320.00
      84.351     0.997266       322825       365.71
      86.335     0.997656       322955       426.67
      88.447     0.998047       323082       512.00
      89.343     0.998242       323142       568.89
      90.367     0.998437       323206       640.00
      91.391     0.998633       323269       731.43
      92.415     0.998828       323335       853.33
      93.311     0.999023       323397      1024.00
      93.695     0.999121       323426      1137.78
      94.207     0.999219       323460      1280.00
      94.591     0.999316       323493      1462.86
      94.911     0.999414       323521      1706.67
      95.359     0.999512       323552      2048.00
      95.551     0.999561       323569      2275.56
      95.935     0.999609       323586      2560.00
      96.383     0.999658       323602      2925.71
      96.767     0.999707       323618      3413.33
      97.279     0.999756       323633      4096.00
      97.471     0.999780       323640      4551.11
      97.791     0.999805       323650      5120.00
      97.983     0.999829       323657      5851.43
      98.303     0.999854       323665      6826.67
      98.687     0.999878       323673      8192.00
      98.815     0.999890       323676      9102.22
      99.327     0.999902       323679     10240.00
      99.839     0.999915       323683     11702.86
     100.223     0.999927       323687     13653.33
     100.735     0.999939       323691     16384.00
     100.863     0.999945       323693     18204.44
     101.439     0.999951       323695     20480.00
     102.015     0.999957       323697     23405.71
     103.167     0.999963       323699     27306.67
     103.423     0.999969       323701     32768.00
     103.935     0.999973       323702     36408.89
     103.999     0.999976       323703     40960.00
     104.639     0.999979       323704     46811.43
     106.431     0.999982       323705     54613.33
     106.751     0.999985       323706     65536.00
     106.751     0.999986       323706     72817.78
     107.839     0.999988       323707     81920.00
     107.839     0.999989       323707     93622.86
     108.223     0.999991       323708    109226.67
     108.223     0.999992       323708    131072.00
     108.223     0.999993       323708    145635.56
     108.543     0.999994       323710    163840.00
     108.543     1.000000       323710          inf
#[Mean    =        4.161, StdDeviation   =        9.922]
#[Max     =      108.480, Total count    =       323710]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  486909 requests in 30.00s, 27.52MB read
Requests/sec:  16229.88
Transfer/sec:      0.92MB
```

[Результаты профилирования `cpu`](put_cpu_hw3.htm)
[Результаты профилирования `alloc`](put_alloc_hw3.htm)
[Результаты_профилирования `lock`](put_lock_hw3.htm)

По профилированию cpu становится понятно, что теперь на получение данных на ноде в которую шли запросы стало не большим
-- всего 0.88%.

При этом зтом увеличилось в процентах время ожидания getTask из пула воркеров, с 9.14% до 30.47%.
И 15.61% времени тратиться на отправку и ожидание запроса к другой ноде, тут, я думаю, помог бы асинхронный клиент,
чтобы не ждать ответа на запрос.

Так же время select'а у селектора изменилось не значительно с 7.52% до 8.07
Время read'a у селектора уменьшилось с 25.9% до 6.36%. 

Добавились аллокации при парсинге ответа, создании future и запросе в другой сервис, которые занимают суммарно 36.47%,
которые, как мне кажется улучшить нельзя при использовании java.net.HttpClient, возможно другие клиенты выделяют меньше памяти,
но без парсинга ответа не обойтись, и для ожидания ответа нужна future.
Т.к. на парсинг уходит 18.59% возможно помогло бы в целом использование HTTP2 и что-нибудь типа grpc и передачи бинарных данных,
которые в целом меньше, и не хранят много лишних хедеров.
Так же значительную часть -- 21.23% занимает отправка ответа, которая тоже создает future. 
12.99% уходит на создание подписчика для запроса.

При этом так как rocksDB не профилируется, полезные аллокации оценить не предстовляется возможным по результатам профилирования.

Так же ожидаемо появились локи для получения ответа от других нод. 
Так как клиент не асинхронный мы ждем 29.71% на отправке запроса.
Ждем на подписчиках 13.77%, и 17.74% ждем на окончании получения ответа на регистрации тригера cleanUp'a

С локами точно поможет асинхронный клиент.


# GET

выдерживаемый рейт так же уменьшился, но не так сильно, выдерживается 22500.

`wrk2 -R 22500 -c 64 -t 4 -d 30 -s src/main/java/ok/dht/test/ilin/scripts/get.lua -L http://localhost:19234`

```
Running 30s test @ http://localhost:19234
  4 threads and 64 connections
  Thread calibration: mean lat.: 69.729ms, rate sampling interval: 543ms
  Thread calibration: mean lat.: 69.902ms, rate sampling interval: 544ms
  Thread calibration: mean lat.: 70.217ms, rate sampling interval: 547ms
  Thread calibration: mean lat.: 69.799ms, rate sampling interval: 544ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     4.36ms    3.79ms  24.06ms   86.17%
    Req/Sec     5.63k    60.57     5.83k    75.69%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    3.03ms
 75.000%    5.42ms
 90.000%    9.16ms
 99.000%   19.25ms
 99.900%   22.35ms
 99.990%   23.34ms
 99.999%   23.79ms
100.000%   24.08ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.092     0.000000            1         1.00
       1.288     0.100000        44891         1.11
       1.724     0.200000        89758         1.25
       2.105     0.300000       134591         1.43
       2.523     0.400000       179519         1.67
       3.029     0.500000       224265         2.00
       3.341     0.550000       246668         2.22
       3.717     0.600000       269015         2.50
       4.175     0.650000       291507         2.86
       4.731     0.700000       313947         3.33
       5.423     0.750000       336358         4.00
       5.835     0.775000       347498         4.44
       6.311     0.800000       358738         5.00
       6.855     0.825000       369922         5.71
       7.491     0.850000       381140         6.67
       8.207     0.875000       392392         8.00
       8.639     0.887500       397917         8.89
       9.159     0.900000       403564        10.00
       9.791     0.912500       409122        11.43
      10.623     0.925000       414745        13.33
      11.631     0.937500       420334        16.00
      12.119     0.943750       423136        17.78
      12.631     0.950000       425958        20.00
      13.223     0.956250       428768        22.86
      13.991     0.962500       431553        26.67
      14.935     0.968750       434345        32.00
      15.487     0.971875       435742        35.56
      16.007     0.975000       437149        40.00
      16.495     0.978125       438558        45.71
      17.023     0.981250       439976        53.33
      17.583     0.984375       441371        64.00
      17.935     0.985938       442067        71.11
      18.399     0.987500       442747        80.00
      18.959     0.989062       443455        91.43
      19.439     0.990625       444152       106.67
      19.919     0.992188       444854       128.00
      20.175     0.992969       445203       142.22
      20.447     0.993750       445565       160.00
      20.687     0.994531       445907       182.86
      20.943     0.995313       446267       213.33
      21.199     0.996094       446604       256.00
      21.359     0.996484       446787       284.44
      21.503     0.996875       446959       320.00
      21.631     0.997266       447125       365.71
      21.775     0.997656       447306       426.67
      21.951     0.998047       447489       512.00
      22.015     0.998242       447566       568.89
      22.111     0.998437       447672       640.00
      22.175     0.998633       447752       731.43
      22.271     0.998828       447831       853.33
      22.351     0.999023       447920      1024.00
      22.399     0.999121       447959      1137.78
      22.463     0.999219       448000      1280.00
      22.543     0.999316       448046      1462.86
      22.639     0.999414       448090      1706.67
      22.719     0.999512       448132      2048.00
      22.783     0.999561       448155      2275.56
      22.847     0.999609       448178      2560.00
      22.927     0.999658       448201      2925.71
      22.975     0.999707       448219      3413.33
      23.055     0.999756       448241      4096.00
      23.119     0.999780       448253      4551.11
      23.167     0.999805       448263      5120.00
      23.231     0.999829       448275      5851.43
      23.263     0.999854       448286      6826.67
      23.311     0.999878       448297      8192.00
      23.343     0.999890       448305      9102.22
      23.359     0.999902       448307     10240.00
      23.407     0.999915       448312     11702.86
      23.439     0.999927       448319     13653.33
      23.455     0.999939       448323     16384.00
      23.471     0.999945       448327     18204.44
      23.487     0.999951       448333     20480.00
      23.487     0.999957       448333     23405.71
      23.503     0.999963       448336     27306.67
      23.519     0.999969       448339     32768.00
      23.519     0.999973       448339     36408.89
      23.583     0.999976       448341     40960.00
      23.583     0.999979       448341     46811.43
      23.615     0.999982       448342     54613.33
      23.759     0.999985       448344     65536.00
      23.759     0.999986       448344     72817.78
      23.791     0.999988       448346     81920.00
      23.791     0.999989       448346     93622.86
      23.791     0.999991       448346    109226.67
      23.855     0.999992       448347    131072.00
      23.855     0.999993       448347    145635.56
      23.919     0.999994       448348    163840.00
      23.919     0.999995       448348    187245.71
      23.919     0.999995       448348    218453.33
      23.951     0.999996       448349    262144.00
      23.951     0.999997       448349    291271.11
      23.951     0.999997       448349    327680.00
      23.951     0.999997       448349    374491.43
      23.951     0.999998       448349    436906.67
      24.079     0.999998       448350    524288.00
      24.079     1.000000       448350          inf
#[Mean    =        4.356, StdDeviation   =        3.794]
#[Max     =       24.064, Total count    =       448350]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  674162 requests in 30.00s, 40.49MB read
Requests/sec:  22471.58
Transfer/sec:      1.35MB
```

[Результаты профилирования `cpu`](get_cpu_hw3.htm)
[Результаты профилирования `alloc`](get_alloc_hw3.htm)
[Результаты профилирования `lock`](get_lock_hw3.htm)

увеличилсоь время на ожидание задачи у воркера с 17.27% до 33.61%
на отправку запроса тратиться 16.17%, на запись ответа почти не тратиться время по сравнению с остальным, всего 3.09%,
а в прошлой задаче было 30.38, При этом чтение из селектором уменьшилось с 26.98% до 5.73%.
На работу тред пула исполнений тратиться 33.14%, раньше было 42.73% 
Но надо учитывать что теперь мы ждем ответа 16.83%, т.е. полезная нагрузка сильно уменьшилась.


большая часть аллокаций тратиться на отправку запроса 83.44%.
Так же как и в прошлом случае, тут не то чтобы можно было оптимизировать это.

В локах, теперь мы не ждем на получении задачи, но так же как и путе очень много локов на ожидание ответа от другой ноды 65.58%,
тут так же сильно бы помог асинхронный клиент.