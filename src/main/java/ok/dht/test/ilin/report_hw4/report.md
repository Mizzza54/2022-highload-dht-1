Тестирование при 3 шардах, все запускалось на Mac m1 в трех jvm.
(Хотелось бы запускать на реальных физических машинах, но это стоит денег, а баллы за них давать пока что не очень
хотят)

# PUT

`wrk2 -R 35000 -c 64 -t 4 -d 30 -s src/main/java/ok/dht/test/ilin/scripts/put.lua -L http://localhost:19234`

```
Running 30s test @ http://localhost:19234
  4 threads and 64 connections
  Thread calibration: mean lat.: 3.444ms, rate sampling interval: 12ms
  Thread calibration: mean lat.: 3.456ms, rate sampling interval: 12ms
  Thread calibration: mean lat.: 3.387ms, rate sampling interval: 11ms
  Thread calibration: mean lat.: 3.450ms, rate sampling interval: 12ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.71ms    3.48ms  59.17ms   95.36%
    Req/Sec     9.14k     1.63k   23.45k    77.56%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.99ms
 75.000%    3.23ms
 90.000%    4.70ms
 99.000%   14.19ms
 99.900%   52.61ms
 99.990%   56.61ms
 99.999%   58.37ms
100.000%   59.20ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.054     0.000000            1         1.00
       0.802     0.100000        69777         1.11
       1.101     0.200000       139626         1.25
       1.376     0.300000       209322         1.43
       1.659     0.400000       278921         1.67
       1.985     0.500000       348589         2.00
       2.181     0.550000       383575         2.22
       2.401     0.600000       418283         2.50
       2.647     0.650000       453163         2.86
       2.925     0.700000       488136         3.33
       3.233     0.750000       522966         4.00
       3.405     0.775000       540281         4.44
       3.595     0.800000       557741         5.00
       3.805     0.825000       575143         5.71
       4.049     0.850000       592607         6.67
       4.335     0.875000       610176         8.00
       4.503     0.887500       618864         8.89
       4.695     0.900000       627590        10.00
       4.915     0.912500       636235        11.43
       5.187     0.925000       644938        13.33
       5.531     0.937500       653573        16.00
       5.751     0.943750       657988        17.78
       6.007     0.950000       662287        20.00
       6.339     0.956250       666655        22.86
       6.771     0.962500       671010        26.67
       7.403     0.968750       675345        32.00
       7.815     0.971875       677526        35.56
       8.343     0.975000       679699        40.00
       8.999     0.978125       681896        45.71
       9.823     0.981250       684059        53.33
      10.911     0.984375       686239        64.00
      11.559     0.985938       687338        71.11
      12.351     0.987500       688414        80.00
      13.415     0.989062       689503        91.43
      14.751     0.990625       690594       106.67
      16.279     0.992188       691684       128.00
      17.103     0.992969       692228       142.22
      18.159     0.993750       692772       160.00
      19.791     0.994531       693314       182.86
      22.239     0.995313       693863       213.33
      27.583     0.996094       694402       256.00
      32.031     0.996484       694675       284.44
      36.767     0.996875       694949       320.00
      40.927     0.997266       695219       365.71
      45.119     0.997656       695492       426.67
      47.743     0.998047       695768       512.00
      48.927     0.998242       695903       568.89
      49.983     0.998437       696037       640.00
      50.943     0.998633       696175       731.43
      51.871     0.998828       696312       853.33
      52.703     0.999023       696451      1024.00
      53.087     0.999121       696518      1137.78
      53.407     0.999219       696586      1280.00
      53.759     0.999316       696651      1462.86
      54.143     0.999414       696723      1706.67
      54.495     0.999512       696787      2048.00
      54.719     0.999561       696826      2275.56
      54.879     0.999609       696853      2560.00
      55.167     0.999658       696888      2925.71
      55.391     0.999707       696923      3413.33
      55.647     0.999756       696957      4096.00
      55.839     0.999780       696974      4551.11
      55.935     0.999805       696990      5120.00
      56.031     0.999829       697006      5851.43
      56.223     0.999854       697024      6826.67
      56.447     0.999878       697040      8192.00
      56.543     0.999890       697049      9102.22
      56.639     0.999902       697057     10240.00
      56.735     0.999915       697066     11702.86
      56.863     0.999927       697075     13653.33
      57.087     0.999939       697086     16384.00
      57.119     0.999945       697088     18204.44
      57.215     0.999951       697091     20480.00
      57.375     0.999957       697096     23405.71
      57.471     0.999963       697101     27306.67
      57.599     0.999969       697104     32768.00
      57.759     0.999973       697106     36408.89
      57.791     0.999976       697109     40960.00
      57.951     0.999979       697111     46811.43
      57.983     0.999982       697113     54613.33
      58.111     0.999985       697115     65536.00
      58.207     0.999986       697116     72817.78
      58.271     0.999988       697117     81920.00
      58.367     0.999989       697119     93622.86
      58.367     0.999991       697119    109226.67
      58.463     0.999992       697120    131072.00
      58.527     0.999993       697121    145635.56
      58.527     0.999994       697121    163840.00
      58.655     0.999995       697122    187245.71
      58.655     0.999995       697122    218453.33
      58.687     0.999996       697123    262144.00
      58.687     0.999997       697123    291271.11
      58.687     0.999997       697123    327680.00
      58.783     0.999997       697124    374491.43
      58.783     0.999998       697124    436906.67
      58.783     0.999998       697124    524288.00
      58.783     0.999998       697124    582542.22
      58.783     0.999998       697124    655360.00
      59.199     0.999999       697125    748982.86
      59.199     1.000000       697125          inf
#[Mean    =        2.707, StdDeviation   =        3.483]
#[Max     =       59.168, Total count    =       697125]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1048604 requests in 30.00s, 67.00MB read
Requests/sec:  34954.12
Transfer/sec:      2.23MB
```

[Результаты профилирования `cpu`](put_hw4_cpu.html)
[Результаты профилирования `alloc`](put_hw4_alloc.html)
[Результаты_профилирования `lock`](put_hw4_lock.html)

Сервер много cpu тратит на запись ответа в сессию -- 22.78% это время улучшить не представляется возможным. Так же много
времени тратим на ожидание ответов на запросы с других нод -- 14.26%, при этом запросы посылаются в отдельных потоках и
улучшить время ожидания ответов если мы хотим синхронно дать ответ не предоставляется возможным.

Хорошо для нас, что достаточно много времени -- 15.87% тратится на запись в RocksDB, улучшить это время используя эту
реализацию бд не получиться, но для нас это полезное время.

14.53% тратиться на ожидании задачи из пула, 18.37% тратиться на чтение запроса из сессии, 5.32% тратим на select
селектором.

Все еще много времени тратиться на one nio, и улучшить это не получиться.

При этом в треде исполнения мы все еще ждем результата, чтобы его записать, и возможно здесь помогла бы асинхронность

На профилировании не видны аллокации самой RocksDB, по этому не очень корректно оценивать реальные аллокации.

Очень много аллокаций тратиться на сериализацию сущности для хранения в бд, это необходимо для того чтобы можно было
сохранить timestamp и tombstone, я думаю что улучшило бы это нормальная сериализация, но к сожалению она не доступна, а
доступна только способ из java. поэтому тратиться много на создание ObjectOutputStream.

Так же относительно много тратиться на обработку запроса, в том числе из-за использования TreeMap, и аллокаций в нем.

Большая часть ождания на локах происходит на получение задачи -- 80.2%.

# GET

выдерживаемый рейт так же уменьшился, но не так сильно, выдерживается 22500.

`wrk2 -R 31500 -c 64 -t 4 -d 30 -s src/main/java/ok/dht/test/ilin/scripts/get.lua -L http://localhost:19234`

```
Running 30s test @ http://localhost:19234
  4 threads and 64 connections
  Thread calibration: mean lat.: 7.066ms, rate sampling interval: 12ms
  Thread calibration: mean lat.: 7.016ms, rate sampling interval: 12ms
  Thread calibration: mean lat.: 7.004ms, rate sampling interval: 11ms
  Thread calibration: mean lat.: 6.967ms, rate sampling interval: 11ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.71ms    3.01ms  40.32ms   94.99%
    Req/Sec     8.24k     1.30k   15.10k    73.37%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    2.09ms
 75.000%    3.27ms
 90.000%    4.60ms
 99.000%   18.64ms
 99.900%   32.86ms
 99.990%   36.67ms
 99.999%   39.26ms
100.000%   40.35ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.085     0.000000            1         1.00
       0.805     0.100000        62852         1.11
       1.129     0.200000       125665         1.25
       1.425     0.300000       188394         1.43
       1.734     0.400000       251126         1.67
       2.089     0.500000       313785         2.00
       2.291     0.550000       345295         2.22
       2.507     0.600000       376694         2.50
       2.735     0.650000       407865         2.86
       2.989     0.700000       439385         3.33
       3.271     0.750000       470595         4.00
       3.427     0.775000       486217         4.44
       3.603     0.800000       501964         5.00
       3.797     0.825000       517705         5.71
       4.017     0.850000       533286         6.67
       4.275     0.875000       549014         8.00
       4.427     0.887500       556875         8.89
       4.599     0.900000       564789        10.00
       4.795     0.912500       572510        11.43
       5.027     0.925000       580320        13.33
       5.331     0.937500       588215        16.00
       5.511     0.943750       592079        17.78
       5.727     0.950000       596023        20.00
       5.991     0.956250       599934        22.86
       6.323     0.962500       603882        26.67
       6.799     0.968750       607775        32.00
       7.119     0.971875       609724        35.56
       7.543     0.975000       611696        40.00
       8.103     0.978125       613646        45.71
       9.039     0.981250       615605        53.33
      10.855     0.984375       617565        64.00
      12.463     0.985938       618546        71.11
      14.535     0.987500       619523        80.00
      16.879     0.989062       620506        91.43
      19.775     0.990625       621486       106.67
      22.303     0.992188       622464       128.00
      23.423     0.992969       622960       142.22
      24.703     0.993750       623449       160.00
      25.887     0.994531       623935       182.86
      27.007     0.995313       624430       213.33
      27.999     0.996094       624917       256.00
      28.479     0.996484       625169       284.44
      29.039     0.996875       625411       320.00
      29.615     0.997266       625650       365.71
      30.207     0.997656       625898       426.67
      30.927     0.998047       626142       512.00
      31.295     0.998242       626264       568.89
      31.647     0.998437       626386       640.00
      32.095     0.998633       626515       731.43
      32.463     0.998828       626630       853.33
      32.927     0.999023       626765      1024.00
      33.087     0.999121       626814      1137.78
      33.375     0.999219       626877      1280.00
      33.727     0.999316       626937      1462.86
      34.015     0.999414       627001      1706.67
      34.335     0.999512       627060      2048.00
      34.559     0.999561       627091      2275.56
      34.751     0.999609       627120      2560.00
      35.007     0.999658       627151      2925.71
      35.231     0.999707       627183      3413.33
      35.551     0.999756       627212      4096.00
      35.711     0.999780       627230      4551.11
      35.807     0.999805       627245      5120.00
      35.999     0.999829       627259      5851.43
      36.191     0.999854       627276      6826.67
      36.415     0.999878       627289      8192.00
      36.575     0.999890       627298      9102.22
      36.735     0.999902       627307     10240.00
      36.895     0.999915       627312     11702.86
      37.119     0.999927       627320     13653.33
      37.311     0.999939       627330     16384.00
      37.343     0.999945       627331     18204.44
      37.567     0.999951       627335     20480.00
      37.727     0.999957       627340     23405.71
      37.855     0.999963       627343     27306.67
      38.047     0.999969       627346     32768.00
      38.143     0.999973       627348     36408.89
      38.207     0.999976       627350     40960.00
      38.367     0.999979       627353     46811.43
      38.463     0.999982       627354     54613.33
      38.655     0.999985       627356     65536.00
      38.847     0.999986       627357     72817.78
      39.103     0.999988       627358     81920.00
      39.263     0.999989       627359     93622.86
      39.391     0.999991       627360    109226.67
      39.519     0.999992       627361    131072.00
      39.519     0.999993       627361    145635.56
      39.615     0.999994       627363    163840.00
      39.615     0.999995       627363    187245.71
      39.615     0.999995       627363    218453.33
      39.615     0.999996       627363    262144.00
      39.615     0.999997       627363    291271.11
      39.775     0.999997       627364    327680.00
      39.775     0.999997       627364    374491.43
      39.775     0.999998       627364    436906.67
      39.775     0.999998       627364    524288.00
      39.775     0.999998       627364    582542.22
      40.351     0.999998       627365    655360.00
      40.351     1.000000       627365          inf
#[Mean    =        2.708, StdDeviation   =        3.012]
#[Max     =       40.320, Total count    =       627365]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  943680 requests in 30.00s, 81.80MB read
Requests/sec:  31455.80
Transfer/sec:      2.73MB
```

[Результаты профилирования `cpu`](get_cpu_hw3.htm)
[Результаты профилирования `alloc`](get_alloc_hw3.htm)
[Результаты профилирования `lock`](get_lock_hw3.htm)

так же много времени занимает запись ответа в сессию 26.83%, на чтение из сессии 19.47%, на select селектора 5.41% и
улучшить это не получиться

так же как и с put много времени уходит на ожидание ответа от других нод -- 15.82%, и на то чтобы взять задачу 17.7%

к сожалению для нас, полезное время -- get из базы, относительно не большой 4.58%.

На десериализацию тратим относительно много времени -- 3.31%, которая возможно улучшилась бы, при использовании другого
десериализатора

Критично много аллокаций тратим на десериализацию -- 37%, что тоже могло бы улучшиться при использовании другого
десереализатора -- в данном случае на создание ObjectInputStream тратиться 20.14$

Так же как и с put много аллокаций на логику с получением нод.

10.06% уходит на запись ответа, 15.98% на чтение запроса.

На профилировании не видны аллокации самой RocksDB, по этому не очень корректно оценивать реальные аллокации.

Так же большое время локов стоим на получение задачи 80.79%.
Так же стоим на добавление в очереди, для http client'a и для добавление future.
